image: maven:3.6.3

clone:
  depth: full              # SonarCloud scanner needs the full history to assign issues properly

#The definitions property is used to define resources used elsewhere in your pipeline configuration.
definitions:
  caches:
    sonar: ~/.sonar/cache  # Caching SonarCloud artifacts will speed up your build
  steps:
    - step: &build
        name: Maven Build
        caches:
          - maven
        script:
          - mvn clean install
        artifacts:
          - target/*.war
          
    - step: &test
        name: Analyze code with Sonarcloud
        caches:
          - maven
          - sonar
        script:
          #- mvn sonar:sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
          #- mvn verify sonar:sonar -Dsonar.projectKey=fs-bitbucket_registration_portal_AYqm6EfyTTYnAsqkkhUh
          - mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
       
    #- step: &deploy
       # name: Deployment on tomcat
       # caches:
       #   - maven
       # script:
         # - cp -rvf target/*.war /home/fs-shubhranshu/Tomcat/apache-tomcat-9.0.78/webapps/
         # - ls -l /home/fs-shubhranshu/Tomcat/apache-tomcat-9.0.78/webapps/
          
    - step: &Jfrog
        name: Jfrog Artifactory
        script:
          - pipe: JfrogDev/artifactory-generic-upload:0.1.0
            variables:
              ARTIFACTORY_URL: $ARTIFACTORY_URL
              ARTIFACTORY_USER: $ARTIFACTORY_USER
              ARTIFACTORY_PASSWORD: $ARTIFACTORY_PASSWORD
              FILE_SPEC: "false"
              SOURCE_PATH: "generic/*.zip"
              TARGET_PATH: "generic-local/"
              BUILD_NAME: "generic-pipe-example"
 
    
pipelines:
  default:
    - step: *build
    - step: *test
    #- step: *deploy
    - step: *Jfrog